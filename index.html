<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Hỗ trợ đọc hóa đơn điện</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .container { max-width: 900px; margin: auto; }
    textarea { width: 100%; height: 200px; }
    input, button { margin: 5px 0; padding: 6px; }
    .result { white-space: pre-wrap; background: #f8f8f8; padding: 10px; border: 1px solid #ccc; }
  </style>
</head>
<body>
<div class="container">
  <h2>📄 Ứng dụng đọc hóa đơn điện → điền vào Excel</h2>

  <label>Chọn file PDF hóa đơn:</label>
  <input type="file" id="pdfFile" accept="application/pdf">

  <label>Chọn file Excel mẫu:</label>
  <input type="file" id="excelFile" accept=".xlsx">

  <label>Mã tỉnh:</label>
  <input type="text" id="maTinh" value="YBI">

  <label>Kỳ:</label>
  <input type="number" id="ky" value="1">

  <button onclick="processFiles()">Đọc hóa đơn → Điền vào Excel</button>

  <h3>Kết quả trích xuất</h3>
  <div id="output" class="result"></div>

  <h3>Tải file Excel đã điền</h3>
  <button id="downloadExcel" style="display:none;">Tải Excel đã điền</button>
</div>

<script>
async function pdfToText(file) {
  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
  let textContent = '';
  for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
    const page = await pdf.getPage(pageNum);
    const content = await page.getTextContent();
    const strings = content.items.map(item => item.str);
    textContent += strings.join(' ') + '\n';
  }
  return textContent;
}

// --- Hàm trích xuất mới ---
function extractInvoiceFields(text){
  const stripDiacritics = s => s.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  const norm = s => stripDiacritics(String(s||''))
    .replace(/\r?\n/g,' ')
    .replace(/\s+/g,' ')
    .toLowerCase();
  const N = norm(text);
  const numVN = s => s ? parseInt(s.replace(/[^\d]/g,''),10) : null;

  function findNear(keywords, pattern, span=180){
    const keys = keywords.map(k=>norm(k));
    let pos = -1;
    for(const k of keys){ pos = N.indexOf(k); if(pos>=0) break; }
    if(pos < 0) return null;
    const chunk = N.slice(pos, Math.min(N.length, pos + span));
    const m = chunk.match(pattern);
    return m ? m[1] : null;
  }

  const out = {};

  let m = text.match(/Số\s*\(No\)\s*[:：]\s*([0-9]+)/i);
  out.invoiceNo = m ? m[1] : null;

  const cust = findNear(
    ['Mã khách hàng','Ma khach hang','Customer\'s Code','Customer Code'],
    /([a-z0-9]{6,})/i
  );
  out.customerCode = cust ? cust.toUpperCase() : null;

  m = N.match(/tu ngay\s*([0-9]{2}\/[0-9]{2}\/[0-9]{4}).{0,80}?den ngay\s*([0-9]{2}\/[0-9]{2}\/[0-9]{4})/i);
  if(m){
    out.periodStart = m[1];
    out.periodEnd   = m[2];
    out.monthCode   = out.periodEnd ? out.periodEnd.slice(6,10)+out.periodEnd.slice(3,5) : null;
  }

  let kw = findNear(['kWh','kwh'], /([0-9\.,]+)/i);
  if(!kw){
    m = text.match(/kWh\s*([0-9\.,]+)/i) || text.match(/([0-9\.,]+)\s*kWh/i);
    kw = m ? m[1] : null;
  }
  out.kwh = numVN(kw);

  const amountBefore = findNear(
    ['Cộng tiền hàng','Cong tien hang','Total amount'],
    /([0-9][0-9\.,]{3,})/
  );
  out.amountBefore = numVN(amountBefore);

  const vat = findNear(
    ['Tiền thuế GTGT','Tien thue GTGT','VAT amount'],
    /([0-9][0-9\.,]{3,})/
  );
  out.vatAmount = numVN(vat);

  const total = findNear(
    ['Tổng cộng tiền thanh toán','Tong cong tien thanh toan','Total payment'],
    /([0-9][0-9\.,]{3,})/
  );
  out.totalAmount = numVN(total);

  return out;
}

let excelData = null;

async function processFiles(){
  const pdfFile = document.getElementById('pdfFile').files[0];
  const excelFile = document.getElementById('excelFile').files[0];
  const maTinh = document.getElementById('maTinh').value.trim();
  const ky = parseInt(document.getElementById('ky').value,10);

  if(!pdfFile || !excelFile){
    alert("Vui lòng chọn đủ file PDF và Excel mẫu!");
    return;
  }

  const text = await pdfToText(pdfFile);
  const fields = extractInvoiceFields(text);

  fields.maTinh = maTinh;
  fields.ky = ky;

  document.getElementById('output').textContent = JSON.stringify(fields, null, 2);

  const wb = await readExcelFile(excelFile);
  const ws = wb.Sheets[wb.SheetNames[0]];

  const lastRow = XLSX.utils.sheet_to_json(ws).length + 2;

  ws['A'+lastRow] = { v: fields.maTinh };
  ws['B'+lastRow] = { v: fields.monthCode };
  ws['C'+lastRow] = { v: fields.ky };
  ws['D'+lastRow] = { v: fields.csht || '' };
  ws['E'+lastRow] = { v: fields.customerCode || '' };
  ws['F'+lastRow] = { v: fields.periodStart || '' };
  ws['G'+lastRow] = { v: fields.periodEnd || '' };
  ws['H'+lastRow] = { v: fields.kwh || '' };
  ws['I'+lastRow] = { v: fields.amountBefore || '' };
  ws['J'+lastRow] = { v: fields.vatAmount || '' };
  ws['K'+lastRow] = { v: fields.invoiceNo || '' };
  ws['L'+lastRow] = { v: fields.totalAmount || '' };
  ws['M'+lastRow] = { v: 0 };

  excelData = wb;
  document.getElementById('downloadExcel').style.display = 'inline-block';
}

function readExcelFile(file){
  return new Promise((resolve, reject)=>{
    const reader = new FileReader();
    reader.onload = e=>{
      const data = new Uint8Array(e.target.result);
      const wb = XLSX.read(data, { type: 'array' });
      resolve(wb);
    };
    reader.onerror = reject;
    reader.readAsArrayBuffer(file);
  });
}

document.getElementById('downloadExcel').addEventListener('click', ()=>{
  if(!excelData) return;
  const wbout = XLSX.write(excelData, { bookType: 'xlsx', type: 'array' });
  const blob = new Blob([wbout], { type: 'application/octet-stream' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'Mau_TH_filled.xlsx';
  a.click();
  URL.revokeObjectURL(url);
});
</script>
</body>
</html>
