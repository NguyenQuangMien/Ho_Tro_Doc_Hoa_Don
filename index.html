<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Map hóa đơn điện → Mẫu Excel</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;max-width:1100px;margin:20px auto;padding:0 16px}
    header{margin-bottom:16px}
    h1{font-size:22px;margin:0 0 8px}
    .card{border:1px solid #e5e7eb;border-radius:16px;padding:16px;box-shadow:0 1px 4px rgba(0,0,0,0.04);margin-bottom:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    label{font-weight:600;display:block;margin-bottom:6px}
    input[type=file]{display:block}
    .row{display:grid;grid-template-columns:220px 1fr;gap:12px;align-items:center;margin:6px 0}
    .btn{display:inline-block;padding:10px 14px;border-radius:12px;border:1px solid #111;background:#111;color:#fff;cursor:pointer}
    .btn.secondary{background:#fff;color:#111}
    .muted{color:#6b7280}
    code,pre{background:#f9fafb;border:1px solid #e5e7eb;border-radius:10px;padding:8px}
    .ok{color:#065f46}
    .warn{color:#b45309}
    .err{color:#b91c1c}
    .small{font-size:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .field{display:flex;gap:8px;align-items:center}
    .field input{flex:1;border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px}
    footer{margin-top:24px}
  </style>
  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <header>
    <h1>Nhập liệu hóa đơn điện → Excel (client-side)</h1>
    <div class="muted small">Tải hóa đơn PDF và file mẫu Excel <span class="mono">Mau_TH.xlsx</span>, hệ thống sẽ điền 1 dòng vào sheet <span class="mono">import</span>.</div>
  </header>

  <section class="card">
    <div class="grid">
      <div>
        <label>1) Tải hóa đơn PDF</label>
        <input id="pdfFile" type="file" accept="application/pdf" />
      </div>
      <div>
        <label>2) Tải file mẫu Excel</label>
        <input id="xlsxFile" type="file" accept=".xlsx,.xls" />
      </div>
    </div>
    <div class="row">
      <div class="muted">Tùy chọn:</div>
      <div class="field">
        <label for="maTinh" class="muted">Mã tỉnh</label>
        <input id="maTinh" value="YBI" />
        <label for="ky" class="muted">Kỳ</label>
        <input id="ky" value="1" />
      </div>
    </div>
    <div class="row">
      <div></div>
      <button class="btn" id="btnProcess">Đọc hóa đơn → Điền vào Excel</button>
      <button class="btn secondary" id="btnReset">Làm lại</button>
    </div>
  </section>

  <section class="card">
    <h2 style="font-size:18px;margin-top:0">Kết quả trích xuất</h2>
    <div id="results" class="small mono muted">Chưa có dữ liệu…</div>
  </section>

  <section class="card">
    <h2 style="font-size:18px;margin-top:0">Tải file Excel đã điền</h2>
    <div class="small muted">Bấm nút để tải file Excel mới (sheet <span class="mono">import</span> được thêm 1 dòng).</div>
    <div class="row">
      <div></div>
      <button class="btn" id="btnDownload" disabled>Tải Excel đã điền</button>
    </div>
  </section>

  <footer class="muted small">Triển khai: tạo repo public trên GitHub → bật Pages → tải file này lên làm index.html</footer>

<script>
  const pdfjsLib = window['pdfjs-dist/build/pdf'];
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
  const el = (id) => document.getElementById(id);
  const results = el('results');
  let extracted = null;
  let workbook = null;
  let filledWb = null;

  function show(obj) { results.textContent = JSON.stringify(obj, null, 2); }
  const onlyDigits = (s) => (s||'').replace(/[^\d]/g, '');
  const vnNumToInt = (s) => { const d = onlyDigits(s); return d ? parseInt(d, 10) : null; };

  function extractInvoiceFields(text) {
    const out = {};
    const rx = (r, flags='i') => new RegExp(r, flags);
    out.invoiceNo = (text.match(rx("Số\\s*\\(No\\)\\s*:\\s*([0-9]+)"))||[])[1]||null;
    out.customerCode = (text.match(rx("Mã\\s*khách\\s*hàng.*?:\\s*([A-Z0-9]+)"))||[])[1]||null;
    let m = text.match(/từ ngày\s*([0-9]{2}\/[0-9]{2}\/[0-9]{4}).*?đến ngày\s*([0-9]{2}\/[0-9]{2}\/[0-9]{4})/is);
    if (m) { out.periodStart = m[1]; out.periodEnd = m[2]; }
    m = text.match(/kWh\s*([0-9\.,]+)/i) || text.match(/([0-9\.,]+)\s*kWh/i);
    if (m) out.kwh = vnNumToInt(m[1]);
    m = text.match(/Cộng tiền hàng.*?:\s*([0-9\.,]+)/i);
    if (m) out.amountBefore = vnNumToInt(m[1]);
    m = text.match(/Tiền thuế GTGT.*?:\s*([0-9\.,]+)/i);
    if (m) out.vatAmount = vnNumToInt(m[1]);
    m = text.match(/Tổng cộng tiền thanh toán.*?:\s*([0-9\.,]+)/i);
    if (m) out.totalAmount = vnNumToInt(m[1]);
    if (out.periodEnd) { const [d, mth, y] = out.periodEnd.split('/'); out.monthCode = `${y}${mth}`; }
    return out;
  }

  async function readPdfText(file) {
    const uint8 = new Uint8Array(await file.arrayBuffer());
    const pdf = await pdfjsLib.getDocument({ data: uint8 }).promise;
    let all = '';
    for (let i=1; i<=pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const content = await page.getTextContent();
      const strings = content.items.map(it => it.str);
      all += strings.join('\n') + '\n';
    }
    return all;
  }

  function appendToTemplateAndBuild(extracted, templateWb) {
    const wsName = 'import';
    const ws = templateWb.Sheets[wsName];
    const rows = XLSX.utils.sheet_to_json(ws, { defval: '' });
    const pdfName = (el('pdfFile').files[0]?.name||'').split('.')[0];
    let csht = null;
    const m = pdfName.match(/^(CSHT_[A-Z]{3}_[0-9]{5})/i);
    csht = m ? m[1] : pdfName;
    const newRow = {
      'Mã tỉnh': el('maTinh').value || 'YBI',
      'Mã tháng (yyyyMM)': extracted.monthCode || '',
      'Kỳ': el('ky').value || '1',
      'Mã CSHT': csht || '',
      'Mã EVN': extracted.customerCode || '',
      'Ngày đầu kỳ (dd/MM/yyyy)\n(Bắt buộc định dạng text)': extracted.periodStart || '',
      'Ngày cuối kỳ (dd/MM/yyyy)\n(Bắt buộc định dạng text)': extracted.periodEnd || '',
      'Tổng chỉ số': extracted.kwh || '',
      'Số tiền': extracted.amountBefore || '',
      'Thuế VAT': extracted.vatAmount || '',
      'Số hóa đơn': extracted.invoiceNo || '',
      'Số tiền dự kiến': extracted.totalAmount || '',
      'Ghi chú': 'Map dự kiến từ hóa đơn điện tử'
    };
    rows.push(newRow);
    const newWs = XLSX.utils.json_to_sheet(rows);
    const outWb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(outWb, newWs, wsName);
    return outWb;
  }

  el('btnProcess').addEventListener('click', async () => {
    try {
      const pdfFile = el('pdfFile').files[0];
      const xlsxFile = el('xlsxFile').files[0];
      if (!pdfFile || !xlsxFile) { alert('Vui lòng chọn cả hóa đơn PDF và file mẫu Excel.'); return; }
      results.textContent = 'Đang đọc PDF…';
      const text = await readPdfText(pdfFile);
      extracted = extractInvoiceFields(text);
      show(extracted);
      results.textContent += '\n\nĐang đọc file mẫu Excel…';
      const data = await xlsxFile.arrayBuffer();
      workbook = XLSX.read(data, { type: 'array' });
      results.textContent += '\n\nĐang ghi dữ liệu…';
      filledWb = appendToTemplateAndBuild(extracted, workbook);
      el('btnDownload').disabled = false;
      results.textContent += '\n\n✅ Hoàn tất. Bấm "Tải Excel đã điền".';
    } catch (err) {
      console.error(err);
      results.innerHTML = `<span class="err">Lỗi: ${err.message}</span>`;
    }
  });

  el('btnDownload').addEventListener('click', () => {
    if (!filledWb) return;
    const wbout = XLSX.write(filledWb, { bookType: 'xlsx', type: 'array' });
    const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `Mau_TH_filled_${Date.now()}.xlsx`;
    a.click();
    URL.revokeObjectURL(a.href);
  });

  el('btnReset').addEventListener('click', () => {
    extracted = null; workbook = null; filledWb = null; results.textContent = 'Chưa có dữ liệu…';
    el('btnDownload').disabled = true;
    el('pdfFile').value = ''; el('xlsxFile').value = '';
  });
</script>
</body>
</html>
