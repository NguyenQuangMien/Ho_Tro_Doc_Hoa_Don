<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Đọc hóa đơn EVN → Excel (không cần mẫu)</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;max-width:1100px;margin:20px auto;padding:0 16px}
  header{margin-bottom:16px} h1{font-size:22px;margin:0 0 8px}
  .card{border:1px solid #e5e7eb;border-radius:16px;padding:16px;box-shadow:0 1px 4px rgba(0,0,0,0.04);margin-bottom:16px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  label{font-weight:600;display:block;margin-bottom:6px}
  input[type=file]{display:block}
  .row{display:grid;grid-template-columns:220px 1fr;gap:12px;align-items:center;margin:6px 0}
  .btn{display:inline-block;padding:10px 14px;border-radius:12px;border:1px solid #111;background:#111;color:#fff;cursor:pointer}
  .btn.secondary{background:#fff;color:#111}
  .muted{color:#6b7280}.small{font-size:12px}.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  pre{background:#f9fafb;border:1px solid #e5e7eb;border-radius:10px;padding:10px;white-space:pre-wrap}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script>pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';</script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<header>
  <h1>Nhập liệu hóa đơn EVN → Excel (client-side, không cần mẫu)</h1>
  <div class="muted small">Chọn nhiều PDF hóa đơn EVN. Hệ thống tự tạo Excel đúng cấu trúc (sheet <span class="mono">import</span>) hoặc nối vào file mẫu nếu bạn tải thêm.</div>
</header>

<section class="card">
  <div class="grid">
    <div>
      <label>1) Chọn hóa đơn PDF (có thể chọn nhiều)</label>
      <input id="pdfFiles" type="file" accept="application/pdf" multiple />
    </div>
    <div>
      <label>2) (Tuỳ chọn) Nạp file Excel mẫu để nối thêm</label>
      <input id="xlsxFile" type="file" accept=".xlsx,.xls" />
      <div class="small muted">Nếu không chọn, hệ thống sẽ tự tạo file Excel chuẩn.</div>
    </div>
  </div>
  <div class="row">
    <div class="muted">Tùy chọn:</div>
    <div>
      <label class="muted">Mã tỉnh</label><input id="maTinh" value="YBI" />
      <label class="muted">Kỳ</label><input id="ky" value="1" />
    </div>
  </div>
  <div class="row">
    <div></div>
    <button class="btn" id="btnProcess">Đọc hóa đơn → Điền vào Excel</button>
    <button class="btn secondary" id="btnReset">Làm lại</button>
  </div>
</section>

<section class="card">
  <h2 style="font-size:18px;margin-top:0">Kết quả trích xuất</h2>
  <pre id="results" class="small mono muted">Chưa có dữ liệu…</pre>
</section>

<section class="card">
  <h2 style="font-size:18px;margin-top:0">Tải file Excel đã điền</h2>
  <div class="small muted">Giữ nguyên tiêu đề sheet <span class="mono">import</span>, chỉ <b>append</b> các dòng theo đúng thứ tự cột.</div>
  <div class="row">
    <div></div>
    <button class="btn" id="btnDownload" disabled>Tải Excel đã điền</button>
  </div>
</section>

<script>
const el = id => document.getElementById(id);
const results = el('results');

function stripDiacritics(s){ return s.normalize('NFD').replace(/[\u0300-\u036f]/g,''); }
const norm = s => stripDiacritics(String(s||'')).replace(/\r?\n/g,' ').replace(/\s+/g,' ').trim().toLowerCase();
const onlyDigits = s => (s||'').replace(/[^\d]/g,'');
const vnNumToInt = s => { const d = onlyDigits(s); return d?parseInt(d,10):null; };

async function readPdfText(file){
  const uint8 = new Uint8Array(await file.arrayBuffer());
  const pdf = await pdfjsLib.getDocument({data:uint8}).promise;
  let all = '';
  for(let i=1;i<=pdf.numPages;i++){
    const page = await pdf.getPage(i);
    const content = await page.getTextContent();
    all += content.items.map(it=>it.str).join('\n')+'\n';
  }
  return all;
}

function extractInvoiceFields(text){
  const N = norm(text);
  const num = s => s ? parseInt(s.replace(/[^\d]/g,''),10) : null;
  function findNear(keys, pattern, span=220){
    const K = keys.map(k=>norm(k));
    let pos = -1; for(const k of K){ pos = N.indexOf(k); if(pos>=0) break; }
    if(pos<0) return null;
    const chunk = N.slice(pos, Math.min(N.length, pos+span));
    const m = chunk.match(pattern);
    return m ? m[1] : null;
  }

  const out = {};

  // Invoice No
  let m = text.match(/Số\s*\(No\)\s*[:：]\s*([0-9]+)/i);
  out.invoiceNo = m ? m[1] : null;

  // Customer Code (rắn hơn)
  let custMatch = text.match(/Mã\s*(KH|Khách\s*hàng|khach\s*hang)[^A-Za-z0-9]{0,10}([A-Z0-9]{5,20})/i);
  if(!custMatch){ custMatch = text.match(/Customer\s*Code[^A-Za-z0-9]{0,10}([A-Z0-9]{5,20})/i); }
  out.customerCode = custMatch ? (custMatch[2] || custMatch[1]) : null;
  if(!out.customerCode){
    const c2 = findNear(['Mã khách hàng','Ma khach hang','Customer Code',"Customer's Code"], /([A-Z0-9]{5,20})/i);
    out.customerCode = c2 ? c2.toUpperCase() : null;
  }

  // Period
  m = N.match(/tu ngay\s*([0-9]{2}\/[0-9]{2}\/[0-9]{4}).{0,120}?den ngay\s*([0-9]{2}\/[0-9]{2}\/[0-9]{4})/i);
  if(m){
    out.periodStart = m[1]; out.periodEnd = m[2];
    out.monthCode = out.periodEnd ? out.periodEnd.slice(6,10)+out.periodEnd.slice(3,5) : null; // yyyyMM
  }

  // kWh
  let kw = findNear(['kWh','kwh'], /([0-9\.,]+)/i);
  if(!kw){ m = text.match(/kWh\s*([0-9\.,]+)/i) || text.match(/([0-9\.,]+)\s*kWh/i); kw = m?m[1]:null; }
  out.kwh = vnNumToInt(kw);

  // Money
  out.amountBefore = vnNumToInt(findNear(['Cộng tiền hàng','Cong tien hang','Total amount'], /([0-9][0-9\.,]{3,})/));
  out.vatAmount    = vnNumToInt(findNear(['Tiền thuế GTGT','Tien thue GTGT','VAT amount'], /([0-9][0-9\.,]{3,})/));
  out.totalAmount  = vnNumToInt(findNear(['Tổng cộng tiền thanh toán','Tong cong tien thanh toan','Total payment'], /([0-9][0-9\.,]{3,})/));

  return out;
}

// ---- Excel helpers ----
const DEFAULT_HEADERS = [
  'Mã tỉnh','Mã tháng (yyyyMM)','Kỳ','Mã CSHT','Mã EVN',
  'Ngày đầu kỳ (dd/MM/yyyy)\n(Bắt buộc định dạng text)',
  'Ngày cuối kỳ (dd/MM/yyyy)\n(Bắt buộc định dạng text)',
  'Tổng chỉ số','Số tiền','Thuế VAT','Số hóa đơn','Số tiền dự kiến','Ghi chú'
];

function createEmptyWorkbook(){
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet([DEFAULT_HEADERS]);
  XLSX.utils.book_append_sheet(wb, ws, 'import');
  return wb;
}

function getOrCreateWorkbook(file){
  return new Promise((resolve,reject)=>{
    if(!file){ resolve(createEmptyWorkbook()); return; }
    const fr = new FileReader();
    fr.onload = e=>{
      try{
        const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
        if(!wb.Sheets['import']){
          const ws = XLSX.utils.aoa_to_sheet([DEFAULT_HEADERS]);
          XLSX.utils.book_append_sheet(wb, ws, 'import');
        }
        resolve(wb);
      }catch(err){ reject(err); }
    };
    fr.onerror = reject;
    fr.readAsArrayBuffer(file);
  });
}

function appendRow(ws, header, data){
  // map theo vị trí tiêu đề chuẩn
  const row = new Array(header.length).fill('');
  const set = (name, val) => { const idx = header.indexOf(name); if(idx>=0) row[idx] = (val==null?'':val); };
  set('Mã tỉnh', data.maTinh);
  set('Mã tháng (yyyyMM)', data.monthCode);
  set('Kỳ', data.ky);
  set('Mã CSHT', data.csht);
  set('Mã EVN', data.customerCode);
  set('Ngày đầu kỳ (dd/MM/yyyy)\n(Bắt buộc định dạng text)', data.periodStart);
  set('Ngày cuối kỳ (dd/MM/yyyy)\n(Bắt buộc định dạng text)', data.periodEnd);
  set('Tổng chỉ số', data.kwh);
  set('Số tiền', data.amountBefore);
  set('Thuế VAT', data.vatAmount);
  set('Số hóa đơn', data.invoiceNo);
  set('Số tiền dự kiến', data.totalAmount);
  set('Ghi chú', 'Map dự kiến từ hóa đơn điện tử');
  XLSX.utils.sheet_add_aoa(ws, [row], {origin:-1});
}

let filledWb = null;

el('btnProcess').addEventListener('click', async ()=>{
  try{
    const pdfFiles = [...(el('pdfFiles').files||[])];
    const tmplFile = el('xlsxFile').files[0] || null;
    if(pdfFiles.length===0){ alert('Vui lòng chọn ít nhất 1 file PDF hóa đơn.'); return; }

    // workbook: lấy từ mẫu hoặc tạo mới
    const wb = await getOrCreateWorkbook(tmplFile);
    const ws = wb.Sheets['import'];
    // đọc header hiện có
    const header = XLSX.utils.sheet_to_json(ws, {header:1, blankrows:false})[0] || DEFAULT_HEADERS;

    const maTinh = el('maTinh').value || 'YBI';
    const ky = parseInt(el('ky').value||'1',10);

    const log = [];
    for(const f of pdfFiles){
      results.textContent = `Đang xử lý: ${f.name}…`;
      const text = await readPdfText(f);
      const ext = extractInvoiceFields(text);

      // CSHT: 3 phần đầu của tên file
      const base = f.name.replace(/\.[^.]+$/,'');
      const parts = base.split('_');
      ext.csht = (parts.length>=3) ? parts.slice(0,3).join('_') : base;

      ext.maTinh = maTinh; ext.ky = ky;

      appendRow(ws, header, {
        maTinh: ext.maTinh, monthCode: ext.monthCode, ky: ext.ky, csht: ext.csht,
        customerCode: ext.customerCode, periodStart: ext.periodStart, periodEnd: ext.periodEnd,
        kwh: ext.kwh, amountBefore: ext.amountBefore, vatAmount: ext.vatAmount,
        invoiceNo: ext.invoiceNo, totalAmount: ext.totalAmount
      });

      log.push({file:f.name, extracted:ext});
    }

    filledWb = wb;
    el('btnDownload').disabled = false;
    results.textContent = JSON.stringify({done:true, files:log}, null, 2) + '\n\n✅ Hoàn tất. Bấm "Tải Excel đã điền".';
  }catch(err){
    console.error(err);
    results.textContent = 'Lỗi: '+err.message;
  }
});

el('btnDownload').addEventListener('click', ()=>{
  if(!filledWb) return;
  const wbout = XLSX.write(filledWb, {bookType:'xlsx', type:'array'});
  const blob = new Blob([wbout], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `Mau_TH_filled_${Date.now()}.xlsx`;
  a.click();
  URL.revokeObjectURL(a.href);
});

el('btnReset').addEventListener('click', ()=>{
  filledWb = null; results.textContent = 'Chưa có dữ liệu…';
  el('btnDownload').disabled = true; el('pdfFiles').value=''; el('xlsxFile').value='';
});
</script>
</body>
</html>
